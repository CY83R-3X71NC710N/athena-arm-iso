name: Build ARM64 ISO (Native macOS)

on:
  workflow_dispatch:
    inputs:
      fedora_version:
        description: 'Fedora release version'
        required: true
        default: '42'
  push:
    branches: [ main, master ]
    paths: 
      - 'athena-iso.ks'

env:
  FEDORA_VERSION: ${{ github.event.inputs.fedora_version || '42' }}
  ISO_NAME: athenaos-live-aarch64.iso

jobs:
  build-native:
    name: Native ARM64 ISO Build
    runs-on: macos-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: System Information
      run: |
        echo "🖥️ System Information:"
        echo "Architecture: $(uname -m)"
        echo "macOS Version: $(sw_vers -productVersion)"
        echo "Available CPU cores: $(sysctl -n hw.ncpu)"
        echo "Available memory: $(sysctl -n hw.memsize | awk '{print $1/1024/1024/1024 " GB"}')"
        
    - name: Install Build Tools via Homebrew
      run: |
        echo "📦 Installing build dependencies..."
        
        # Update Homebrew (suppress verbose output)
        brew update > /dev/null 2>&1
        
        # Install essential tools (skip if already installed)
        echo "Installing system tools..."
        brew list wget || brew install wget
        brew list curl || brew install curl
        brew list git || brew install git
        brew list python@3.13 || brew install python@3.13
        
        # Install pipx for Python package management
        echo "Installing pipx for Python package management..."
        brew list pipx || brew install pipx
        
        # Ensure pipx is in PATH
        echo 'export PATH="$HOME/.local/bin:$PATH"' >> $GITHUB_ENV
        
        # Install pykickstart using pipx (isolated environment)
        echo "Installing pykickstart..."
        pipx install pykickstart
        
    - name: Validate Kickstart File
      run: |
        echo "🔍 Validating kickstart file..."
        
        # Ensure pipx binaries are in PATH
        export PATH="$HOME/.local/bin:$PATH"
        
        # Check if ksvalidator is available
        if command -v ksvalidator > /dev/null 2>&1; then
          echo "Found ksvalidator, running validation..."
          ksvalidator athena-iso.ks || {
            echo "❌ Kickstart validation failed"
            exit 1
          }
          echo "✅ Kickstart file is valid"
        else
          echo "⚠️ ksvalidator not found in PATH, trying alternative validation..."
          
          # Basic syntax check - look for required sections
          if grep -q "%packages" athena-iso.ks && grep -q "%post" athena-iso.ks; then
            echo "✅ Basic kickstart structure validation passed"
          else
            echo "❌ Basic kickstart structure validation failed"
            exit 1
          fi
        fi
        
    - name: Try Alternative Build Method
      run: |
        echo "🧪 Testing alternative build approaches..."
        
        # Since we can't easily install lorax/livemedia-creator on macOS,
        # let's try using a different approach or document the requirements
        
        echo "ℹ️ Native macOS build would require:"
        echo "  - Fedora build tools (lorax, anaconda)"
        echo "  - These are not available via Homebrew"
        echo "  - Container approach is recommended"
        
        # For now, just validate our configuration
        echo "✅ Kickstart validation passed"
        echo "✅ ARM64 architecture confirmed: $(uname -m)"
        
        # Create a mock result for testing
        mkdir -p ./results
        echo "Mock ARM64 ISO build completed on $(date)" > ./results/build_info.txt
        
    - name: Upload Build Info
      uses: actions/upload-artifact@v4
      with:
        name: build-info-native
        path: results/build_info.txt
        retention-days: 7
        
    - name: Build Summary
      run: |
        echo "## 🍎 Native macOS ARM64 Build Test" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### System Info" >> $GITHUB_STEP_SUMMARY
        echo "- **Architecture**: $(uname -m)" >> $GITHUB_STEP_SUMMARY
        echo "- **macOS Version**: $(sw_vers -productVersion)" >> $GITHUB_STEP_SUMMARY
        echo "- **CPU Cores**: $(sysctl -n hw.ncpu)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Results" >> $GITHUB_STEP_SUMMARY
        echo "- ✅ Kickstart file validation passed" >> $GITHUB_STEP_SUMMARY
        echo "- ✅ Native ARM64 environment confirmed" >> $GITHUB_STEP_SUMMARY
        echo "- ℹ️ Full ISO build requires containerized approach" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Recommendation" >> $GITHUB_STEP_SUMMARY
        echo "Use the main build workflow with Podman for full ISO creation."
